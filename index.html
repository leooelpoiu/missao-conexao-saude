<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miss√£o: Conex√£o Sa√∫de</title>
    <!-- Adiciona a biblioteca para leitura de QR Code -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* FONTES */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;700;900&display=swap');

        /* VARI√ÅVEIS DE DESIGN */
        :root {
            --font-pixel: 'Press Start 2P', cursive;
            --font-sans: 'Inter', sans-serif;
            --color-dark: #10101a;
            --color-light: #f0f0f5;
            --color-primary-glow: #00f2a1;
            --color-secondary-glow: #0984e3;
            --color-accent1-glow: #a29bfe; /* Mental */
            --color-accent2-glow: #e84393; /* Sexual */
            --color-accent3-glow: #fdcb6e; /* Adolescencia */
            
            --glass-bg: rgba(30, 30, 42, 0.5);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        /* ESTILOS GERAIS E ANIMA√á√ïES */
        body {
            margin: 0;
            font-family: var(--font-sans);
            background-color: var(--color-dark);
            color: var(--color-light);
            overflow-x: hidden;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
        }

        .screen {
            width: 100vw;
            min-height: 100vh;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            animation: fadeIn 0.7s ease-in-out;
            position: relative;
            z-index: 1;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes screenShake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        .screen.shake {
            animation: screenShake 0.3s ease-in-out;
        }

        .glitch-title {
            font-family: var(--font-pixel);
            text-align: center;
            font-size: 1.5rem;
            text-shadow: 0 0 5px var(--color-primary-glow), 0 0 10px var(--color-primary-glow);
            position: relative;
        }

        button {
            font-family: var(--font-pixel);
            padding: 15px 20px;
            border: 2px solid var(--color-primary-glow);
            border-radius: 8px;
            cursor: pointer;
            text-transform: uppercase;
            background-color: transparent;
            color: var(--color-primary-glow);
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 0 5px var(--color-primary-glow), inset 0 0 5px var(--color-primary-glow);
            text-shadow: 0 0 3px var(--color-primary-glow);
        }

        button:hover, button:focus {
            background-color: var(--color-primary-glow);
            color: var(--color-dark);
            box-shadow: 0 0 15px var(--color-primary-glow), 0 0 25px var(--color-primary-glow);
            text-shadow: none;
            transform: translateY(-3px);
        }
        
        button.secondary {
            border-color: var(--color-secondary-glow);
            color: var(--color-secondary-glow);
            box-shadow: 0 0 5px var(--color-secondary-glow), inset 0 0 5px var(--color-secondary-glow);
            text-shadow: 0 0 3px var(--color-secondary-glow);
        }

        .glass-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        .stars-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: 0;
        }
        .star {
            position: absolute; background: white; border-radius: 50%;
            animation: move linear infinite; box-shadow: 0 0 5px white;
        }
        @keyframes move {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-100vh); opacity: 0; }
        }

        .character-selection { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
        .char-card {
            padding: 15px; width: 240px; text-align: center; cursor: pointer;
            border: 2px solid transparent;
        }
        .char-card:hover, .char-card.selected {
            border-color: var(--color-primary-glow);
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 242, 161, 0.3);
        }
        .char-card h3 {
            font-family: var(--font-pixel); font-size: 1rem; color: var(--color-primary-glow);
            margin-top: 15px; text-shadow: 0 0 4px var(--color-primary-glow);
        }
        .pixel-avatar {
            width: 150px; height: 150px; margin: 0 auto;
            border: 2px solid var(--glass-border); border-radius: 8px;
            background-color: rgba(0,0,0,0.3);
        }
        .pixel-avatar img { width: 100%; height: 100%; border-radius: 6px; image-rendering: pixelated; }
        .char-desc { font-size: 0.8rem; height: 35px; margin-bottom: 10px; color: #bdc3c7; }
        .attributes { text-align: left; font-family: var(--font-sans); font-size: 0.8rem; font-weight: bold; }
        .attr-bar-container {
            width: 100%; height: 12px; background-color: rgba(0,0,0,0.3);
            margin-top: 4px; border-radius: 6px; overflow: hidden;
        }
        .attr-bar {
            height: 100%; background: linear-gradient(90deg, var(--color-secondary-glow), var(--color-primary-glow));
            transition: width 0.5s ease;
        }

        #hub-screen { background-color: transparent; }
        .hub-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; width: 100%; max-width: 900px; }
        .hub-station {
            padding: 15px; text-align: center; font-family: var(--font-pixel); font-size: 0.8rem;
            cursor: pointer; border: 2px solid transparent;
        }
        .hub-station:hover {
            transform: translateY(-5px);
            border-color: white;
        }
        .hub-station.locked { filter: grayscale(80%) brightness(0.6); }
        .hub-station.unlocked { color: white; text-shadow: 0 0 5px currentColor; }
        .hub-station .lock-icon { font-size: 2.5rem; margin-bottom: 10px; transition: transform 0.3s; }
        .hub-station:hover .lock-icon { transform: scale(1.1); }
        .hub-header { grid-column: 1 / -1; margin-bottom: 20px; }
        .hub-overlay { 
            position: fixed; bottom: 15px; right: 15px; text-align: center; 
            cursor: pointer; padding: 8px;
        }
        .hub-overlay .pixel-avatar { width: 80px; height: 80px; }
        .hub-overlay p { font-family: var(--font-pixel); margin-top: 5px; font-size: 0.7rem; text-shadow: 0 0 3px white; }

        .pass-screen { background: transparent; justify-content: flex-start; padding-top: 50px; }
        .agent-pass {
            display: flex; flex-direction: column; align-items: center;
            gap: 20px; padding: 20px; width: 90%; max-width: 800px;
            border-color: var(--color-primary-glow);
        }
        .pass-left { text-align: center; width: 100%; }
        .pass-left .pixel-avatar { width: 180px; height: 180px; }
        .pass-left h3 { font-family: var(--font-pixel); color: var(--color-primary-glow); font-size: 1.2rem; }
        .pass-right { width: 100%; }
        .pass-right h4 { font-family: var(--font-pixel); border-bottom: 2px solid var(--glass-border); padding-bottom: 5px; }
        .stamps-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; }
        .stamp-icon { width: 60px; height: 60px; font-size: 2rem; background-color: rgba(0,0,0,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; color: #6e6e6e; transition: all 0.5s;}
        .stamp-icon.unlocked { color: white; box-shadow: 0 0 10px currentColor; }
        .stamp p { font-size: 0.6rem; }
        
        .achievements-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
        .achievement { padding: 10px; border: 1px solid var(--glass-border); border-radius: 8px; background: rgba(0,0,0,0.2); filter: grayscale(90%) brightness(0.7); transition: all 0.4s ease;}
        .achievement.unlocked { filter: grayscale(0%) brightness(1); border-color: var(--color-accent3-glow); }
        .achievement .name { font-family: var(--font-pixel); font-size: 0.8rem; color: var(--color-accent3-glow); text-shadow: 0 0 4px var(--color-accent3-glow); }
        .achievement .desc { font-size: 0.7rem; color: #bdc3c7; }

        #achievement-toast {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            padding: 15px 20px; font-family: var(--font-pixel); font-size: 0.8rem;
            color: var(--color-dark); background-color: var(--color-accent3-glow);
            border-radius: 12px; z-index: 2000; box-shadow: 0 0 20px var(--color-accent3-glow);
            transition: bottom 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 90%; text-align: center;
        }
        #achievement-toast.show { bottom: 20px; }

        #scanner-screen .scanner-title { color: var(--color-secondary-glow); text-shadow: 0 0 5px var(--color-secondary-glow); }
        #qr-reader {
            width: 250px;
            border: 2px solid var(--glass-border);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        #qr-reader.success { border-color: var(--color-primary-glow); box-shadow: 0 0 10px var(--color-primary-glow); }
        #qr-reader.error { border-color: var(--color-accent2-glow); box-shadow: 0 0 10px var(--color-accent2-glow); }

        #minigame-screen .minigame-title { font-family: var(--font-pixel); font-size: 1.2rem; margin-bottom: 10px; }
        #minigame-screen .minigame-instructions { font-size: 0.9rem; max-width: 90%; text-align: center; margin-bottom: 20px; }
        #minigame-container { width: 100%; max-width: 600px; min-height: 250px; display: flex; flex-direction: column; align-items: center; justify-content: center;}
        
        .force-bar-wrapper { width: 100%; padding: 20px; }
        .force-bar { position: relative; width: 100%; height: 40px; background-color: rgba(0,0,0,0.3); border-radius: 10px; border: 2px solid var(--glass-border); }
        .force-bar-target { position: absolute; height: 100%; background-color: rgba(0, 242, 161, 0.5); border: 2px solid var(--color-primary-glow); }
        .force-bar-indicator { position: absolute; width: 5px; height: 110%; top: -5%; background-color: white; box-shadow: 0 0 10px white; animation: moveIndicator 2s infinite alternate ease-in-out; }
        @keyframes moveIndicator { from { left: 0; } to { left: calc(100% - 5px); } }

        .speed-game-hud { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0 10px; }
        .speed-game-timer { font-family: var(--font-pixel); font-size: 1.5rem; }
        .lives-container { font-size: 1.5rem; }
        .speed-game-area { position: relative; width: 100%; height: 250px; overflow: hidden; border-radius: 8px; border: 2px solid var(--glass-border); margin-top: 10px; }
        .game-icon { position: absolute; font-size: 1.8rem; cursor: pointer; transition: transform 0.2s; user-select: none; }
        .game-icon:hover { transform: scale(1.2); }

        .quiz-question, .dialogue-scenario { font-size: 1rem; }
        .quiz-options, .dialogue-options { display: flex; flex-direction: column; gap: 15px; width: 100%; }
        .quiz-options button, .dialogue-options button { font-size: 0.8rem; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); display: none;
            align-items: center; justify-content: center; z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.visible { display: flex; }
        .modal-content { padding: 20px; width: 90%;}
        .modal-content h2 { font-size: 1.2rem; }
        .tip-box { padding: 15px; background-color: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); border-radius: 8px; margin: 20px 0;}
        .master-tip { border-color: var(--color-accent3-glow); background-color: rgba(253, 203, 110, 0.1); }
        .master-tip p { color: var(--color-accent3-glow); font-weight: bold; }

        @media (min-width: 768px) {
            .glitch-title { font-size: 2.5rem; }
            button { font-size: 1rem; }
            .agent-pass { flex-direction: row; align-items: flex-start; }
            .pass-left { flex-basis: 240px; }
            .pass-right { flex-basis: 400px; }
            .achievements-grid { grid-template-columns: 1fr 1fr; }
            #minigame-screen .minigame-title { font-size: 1.5rem; }
            #minigame-screen .minigame-instructions { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div class="stars-bg" id="stars-bg"></div>
    <div id="achievement-toast"></div>

    <div id="onboarding-screen" class="screen active">
        <div>
            <h1 class="glitch-title" data-text="Escolha seu Agente">Escolha seu Agente</h1>
            <div id="character-selection" class="character-selection" style="margin-top: 30px;"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button id="start-mission-btn">Iniciar Miss√£o</button>
            </div>
        </div>
    </div>

    <div id="hub-screen" class="screen">
        <div class="hub-grid" id="hub-grid"></div>
        <div id="hub-overlay" class="hub-overlay glass-card">
            <div id="hub-avatar" class="pixel-avatar"></div>
            <p>Passe</p>
        </div>
    </div>
    
    <div id="scanner-screen" class="screen">
        <div class="glass-card" style="padding: 30px; text-align: center;">
            <h2 class="scanner-title" id="scanner-title">SCANNER DE ACESSO</h2>
            <p id="scanner-subtitle">Esta√ß√£o: ...</p>
            <div id="qr-reader" style="width: 250px; margin: 20px auto;"></div>
            <p id="scanner-message" style="margin-top: 15px;">Aponte a c√¢mera para o QR Code da esta√ß√£o.</p>
            <div style="margin-top: 20px;">
                <button id="scanner-back-btn">Voltar ao Hub</button>
            </div>
        </div>
    </div>

    <div id="minigame-screen" class="screen">
        <h2 class="minigame-title">Desafio de H√°bito</h2>
        <p class="minigame-instructions">Instru√ß√µes do desafio aqui...</p>
        <div id="minigame-container" class="glass-card"></div>
    </div>

    <div id="pass-screen" class="screen pass-screen">
        <div class="agent-pass glass-card">
            <div class="pass-left">
                <div id="pass-avatar" class="pixel-avatar"></div>
                <h3 id="pass-name">NOME DO AGENTE</h3>
                <h4 style="margin-top: 20px;">SELOS DA MISS√ÉO</h4>
                <div id="stamps-grid" class="stamps-grid"></div>
            </div>
            <div class="pass-right">
                <h4>ATRIBUTOS</h4>
                <div id="pass-attributes" class="attributes" style="font-size: 0.8rem;"></div>
                <h4 style="margin-top: 20px;">CONQUISTAS</h4>
                <div id="achievements-grid" class="achievements-grid"></div>
                <button id="pass-back-btn" style="margin-top: 30px;">Voltar ao Hub</button>
            </div>
        </div>
    </div>

    <div id="discovery-modal" class="modal-overlay">
        <div class="modal-content glass-card">
            <h2 id="modal-title">ESTA√á√ÉO CONCLU√çDA!</h2>
            <div id="modal-tip-box" class="tip-box">
                <p style="font-size: 24px; margin: 0;">üí°</p>
                <p id="modal-tip-text"><strong>Super Dica:</strong> ...</p>
            </div>
            <div id="master-tip-box" class="tip-box master-tip" style="display: none;"></div>
            <button id="modal-close-btn">Continuar Miss√£o</button>
        </div>
    </div>

    <div id="failure-modal" class="modal-overlay">
        <div class="modal-content glass-card">
            <h2 id="failure-title" style="color: var(--color-accent2-glow);">FALHA NO DESAFIO</h2>
            <p>Voc√™ n√£o conseguiu superar o Desafio de H√°bito desta vez.</p>
            <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
                <button id="retry-btn">Tentar Novamente</button>
                <button id="fail-back-to-hub-btn" class="secondary">Voltar ao Hub</button>
            </div>
        </div>
    </div>
    
     <div id="completion-screen" class="screen">
        <h1 class="glitch-title" data-text="MISS√ÉO CUMPRIDA!" style="font-size: 2.5rem; color: #f1c40f; text-shadow: 0 0 5px #f1c40f, 0 0 10px #f1c40f;">MISS√ÉO CUMPRIDA!</h1>
        <div id="completion-avatar" class="pixel-avatar"></div>
        <p style="font-size: 1.2rem; text-align: center; max-width: 600px; margin-top: 20px;">Parab√©ns, Agente! Voc√™ dominou o Circuito.<br>Mostre esta tela ao seu Comandante (professor) para resgatar sua recompensa.</p>
    </div>


    <script>
        const CHARACTERS = {
            ju: { id: 'ju', name: 'Ju', desc: 'Agente Harmonizador, com atributos balanceados.', attributes: { forca: 2, inteligencia: 3, velocidade: 3, carisma: 3 } },
            joao: { id: 'joao', name: 'Jo√£o', desc: 'Agente T√°tico, especialista em velocidade.', attributes: { forca: 2, inteligencia: 2, velocidade: 5, carisma: 2 } },
            leo: { id: 'leo', name: 'L√©o', desc: 'Agente de Vanguarda, focado em for√ßa.', attributes: { forca: 5, inteligencia: 4, velocidade: 3, carisma: 1 } },
            anna: { id: 'anna', name: 'Anna', desc: 'Agente Estrategista, mestre em intelig√™ncia.', attributes: { forca: 1, inteligencia: 5, velocidade: 1, carisma: 5 } }
        };

        const STATIONS = {
            mental: { title: 'Sa√∫de Mental', unlocked: false, qrValue: 'QR_MENTAL_2025', achievementId: 'mental_unlocked', tip: 'Respirar fundo por 1 minuto pode acalmar seu c√©rebro na hora!', challengeAttr: 'inteligencia', masterTip: 'Criar um "di√°rio de gratid√£o" anota 3 coisas boas do dia e melhora o sono.' },
            sexual: { title: 'Sa√∫de Sexual', unlocked: false, qrValue: 'QR_SEXUAL_2025', achievementId: 'sexual_unlocked', tip: 'Conversar abertamente sobre preven√ß√£o √© o maior superpoder.', challengeAttr: 'carisma', masterTip: 'Saber dizer "n√£o" de forma clara e respeitosa √© uma forma de autocuidado e de respeito ao outro.' },
            bucal: { title: 'Sa√∫de Bucal', unlocked: false, qrValue: 'QR_BUCAL_2025', achievementId: 'bucal_unlocked', tip: 'Sua escova de dentes n√£o alcan√ßa tudo! O fio dental √© o melhor amigo dela.', challengeAttr: 'forca', masterTip: 'Esperar 30 minutos para escovar os dentes ap√≥s comer algo √°cido (como refri) protege o esmalte.' },
            nutricao: { title: 'Nutri√ß√£o', unlocked: false, qrValue: 'QR_NUTRICAO_2025', achievementId: 'nutricao_unlocked', tip: 'Beber √°gua antes de sentir sede mant√©m seu corpo com energia m√°xima.', challengeAttr: 'velocidade', masterTip: 'Comer um punhado de castanhas pode dar mais energia para estudar do que um doce.' },
            adolescencia: { title: 'Adolesc√™ncia', unlocked: false, qrValue: 'QR_ADOLESCENCIA_2025', achievementId: 'adolescencia_unlocked', tip: 'Entender as mudan√ßas do seu corpo te d√° mais confian√ßa para tomar decis√µes.', challengeAttr: 'inteligencia', masterTip: 'As emo√ß√µes na adolesc√™ncia s√£o intensas. Aprender a nome√°-las √© o primeiro passo para lidar com elas.' }
        };
        
        const ACHIEVEMENTS = {
            'mental_unlocked': { name: '[T√° na Mente!]', desc: 'Completou a esta√ß√£o de Sa√∫de Mental.', unlocked: false },
            'sexual_unlocked': { name: '[Dei o Papo!]', desc: 'Completou a esta√ß√£o de Sa√∫de Sexual.', unlocked: false },
            'bucal_unlocked': { name: '[Sorriso T√° On]', desc: 'Completou a esta√ß√£o de Sa√∫de Bucal.', unlocked: false },
            'nutricao_unlocked': { name: '[Deixa o Shape Falar]', desc: 'Completou a esta√ß√£o de Nutri√ß√£o.', unlocked: false },
            'adolescencia_unlocked': { name: '[√â Sobre Isso]', desc: 'Completou a esta√ß√£o de Adolesc√™ncia.', unlocked: false },
            'master_tip': { name: '[Foi lan√ßada a Braba!]', desc: 'Obteve uma "Dica de Mestre".', unlocked: false },
            'game_complete': { name: '[Zerou o Game!]', desc: 'Completou todas as cinco esta√ß√µes.', unlocked: false }
        };

        let gameState = { 
            player: null, 
            stations: JSON.parse(JSON.stringify(STATIONS)), 
            achievements: JSON.parse(JSON.stringify(ACHIEVEMENTS)),
            stationToUnlock: null
        };
        let activeGameIntervals = [];

        function navigateTo(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        function showAchievementToast(achievementName) {
            const toast = document.getElementById('achievement-toast');
            toast.textContent = `üèÜ Conquista: ${achievementName}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function unlockAchievement(id) {
            if (!gameState.achievements[id].unlocked) {
                gameState.achievements[id].unlocked = true;
                showAchievementToast(gameState.achievements[id].name);
            }
        }

        function createPixelAvatar(character, container) {
            container.innerHTML = '';
            if (character && character.base64Image) {
                const img = document.createElement('img');
                img.src = character.base64Image;
                img.style.objectFit = 'cover';
                container.appendChild(img);
            }
        }
        
        function setupOnboarding() {
            const container = document.getElementById('character-selection');
            container.innerHTML = '';
            Object.values(CHARACTERS).forEach(char => {
                const card = document.createElement('div');
                card.className = 'char-card glass-card';
                card.dataset.charId = char.id;
                card.innerHTML = `
                    <div class="pixel-avatar"></div>
                    <h3>${char.name}</h3>
                    <p class="char-desc">${char.desc}</p>
                    <div class="attributes">
                        ${Object.entries(char.attributes).map(([attr, val]) => `
                            <div>
                                <span>${attr.charAt(0).toUpperCase() + attr.slice(1)}</span>
                                <div class="attr-bar-container"><div class="attr-bar" style="width: ${val * 20}%;"></div></div>
                            </div>
                        `).join('')}
                    </div>
                `;
                createPixelAvatar(char, card.querySelector('.pixel-avatar'));
                container.appendChild(card);
            });
            
            document.querySelectorAll('.char-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.char-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    gameState.player = CHARACTERS[card.dataset.charId];
                });
            });
        }
        
        function setupHub() {
            const container = document.getElementById('hub-grid');
            let hubHTML = `<div class="hub-header"><h1 class="glitch-title" data-text="HUB DA MISS√ÉO">HUB DA MISS√ÉO</h1></div>`;
            Object.entries(gameState.stations).forEach(([id, station]) => {
                const stationColors = { mental: '#a29bfe', sexual: '#e84393', bucal: '#0984e3', nutricao: '#00b894', adolescencia: '#fdcb6e' };
                const unlockedClass = station.unlocked ? 'unlocked' : 'locked';
                const unlockedStyle = station.unlocked ? `border-color: ${stationColors[id]}; box-shadow: 0 0 10px ${stationColors[id]};` : '';
                const icon = station.unlocked ? '‚úÖ' : 'üîí';
                
                hubHTML += `
                    <div class="hub-station glass-card ${unlockedClass}" style="${unlockedStyle}" data-station-id="${id}">
                        <div class="lock-icon">${icon}</div>
                        <div>${station.title}</div>
                    </div>
                `;
            });
            container.innerHTML = hubHTML;

            container.querySelectorAll('.hub-station').forEach(stationEl => {
                stationEl.addEventListener('click', () => {
                    const stationId = stationEl.dataset.stationId;
                    if (!gameState.stations[stationId].unlocked) {
                        gameState.stationToUnlock = stationId;
                        document.getElementById('scanner-subtitle').textContent = `Esta√ß√£o: ${STATIONS[stationId].title}`;
                        navigateTo('scanner-screen');
                        startQrScanner();
                    }
                });
            });
            createPixelAvatar(gameState.player, document.getElementById('hub-avatar'));
        }

        function handleScan(isCorrect) {
            if (!isCorrect) return;
            
            const stationId = gameState.stationToUnlock;
            const station = gameState.stations[stationId];
            station.unlocked = true;
            unlockAchievement(station.achievementId);
            startMinigame(stationId);
        }

        function showDiscoveryModal(masteryAchieved) {
            navigateTo('discovery-modal');
            const stationId = gameState.stationToUnlock;
            const station = gameState.stations[stationId];

            document.getElementById('modal-title').textContent = `ESTA√á√ÉO CONCLU√çDA!`;
            document.getElementById('modal-tip-text').innerHTML = `<strong>Super Dica:</strong> ${station.tip}`;
            
            const masterTipBox = document.getElementById('master-tip-box');
            if (masteryAchieved) {
                masterTipBox.innerHTML = `<p style="font-size: 24px; margin: 0;">üèÜ</p><p><strong>Dica de Mestre:</strong> ${station.masterTip}</p>`;
                masterTipBox.style.display = 'block';
                unlockAchievement('master_tip');
            } else {
                masterTipBox.style.display = 'none';
            }
        }

        function setupAgentPass() {
            createPixelAvatar(gameState.player, document.getElementById('pass-avatar'));
            document.getElementById('pass-name').textContent = gameState.player.name;
            
            document.getElementById('pass-attributes').innerHTML = Object.entries(gameState.player.attributes).map(([attr, val]) => `
                <div><span>${attr.charAt(0).toUpperCase() + attr.slice(1)}</span><div class="attr-bar-container"><div class="attr-bar" style="width: ${val * 20}%;"></div></div></div>
            `).join('');

            document.getElementById('stamps-grid').innerHTML = Object.entries(gameState.stations).map(([id, station]) => {
                const stationColors = { mental: '#a29bfe', sexual: '#e84393', bucal: '#0984e3', nutricao: '#00b894', adolescencia: '#fdcb6e' };
                const stampIcon = { mental: 'üß†', sexual: '‚ù§Ô∏è', bucal: 'ü¶∑', nutricao: '‚ö°Ô∏è', adolescencia: '‚≠êÔ∏è' };
                return `<div class="stamp"><div class="stamp-icon ${station.unlocked ? 'unlocked' : ''}" style="background-color: ${station.unlocked ? stationColors[id] : 'rgba(0,0,0,0.3)'};">${stampIcon[id]}</div><p>${station.title}</p></div>`;
            }).join('');
            
            document.getElementById('achievements-grid').innerHTML = Object.values(gameState.achievements).map(ach => `
                <div class="achievement ${ach.unlocked ? 'unlocked' : ''}"><div class="name">${ach.name}</div><div class="desc">${ach.desc}</div></div>
            `).join('');
        }
        
        function clearActiveGameIntervals() {
            activeGameIntervals.forEach(interval => clearInterval(interval));
            activeGameIntervals = [];
        }

        function startMinigame(stationId) {
            const station = STATIONS[stationId];
            const attr = station.challengeAttr;
            const container = document.getElementById('minigame-container');
            container.innerHTML = '';
            container.onclick = null;
            clearActiveGameIntervals();

            document.querySelector('#minigame-screen .minigame-title').textContent = `Desafio de ${attr.charAt(0).toUpperCase() + attr.slice(1)}`;
            
            if (attr === 'forca') setupForcaGame(container);
            else if (attr === 'velocidade') setupVelocidadeGame(container);
            else if (attr === 'inteligencia') setupInteligenciaGame(container, stationId);
            else if (attr === 'carisma') setupCarismaGame(container);
            
            navigateTo('minigame-screen');
        }
        
        function endMinigame(success) {
            clearActiveGameIntervals();
            if (success) {
                showDiscoveryModal(true);
            } else {
                document.getElementById('failure-modal').classList.add('visible');
            }
        }

        function setupForcaGame(container) {
            document.querySelector('#minigame-screen .minigame-instructions').textContent = "Toque na tela quando o indicador estiver na zona verde para acertar a for√ßa ideal!";
            
            const targetWidth = 10 + (gameState.player.attributes.forca * 5);
            const targetLeft = Math.random() * (100 - targetWidth);

            container.innerHTML = `<div class="force-bar-wrapper"><div class="force-bar"><div class="force-bar-target" style="left: ${targetLeft}%; width: ${targetWidth}%;"></div><div class="force-bar-indicator"></div></div></div>`;
            
            container.onclick = () => {
                const indicator = container.querySelector('.force-bar-indicator');
                const indicatorAnim = indicator.getAnimations()[0];
                if (indicatorAnim) indicatorAnim.pause();

                const currentPosPercent = (indicator.offsetLeft / container.querySelector('.force-bar').offsetWidth) * 100;
                
                const success = currentPosPercent >= targetLeft && currentPosPercent <= (targetLeft + targetWidth);
                endMinigame(success);
            };
        }

        function setupVelocidadeGame(container) {
             document.querySelector('#minigame-screen .minigame-instructions').textContent = "Toque nos alimentos saud√°veis (üçéü•¶) e evite os n√£o saud√°veis (üç©üçï)!";
             
             const gameTime = 10 + gameState.player.attributes.velocidade;
             let score = 0;
             let lives = 3;
             let timeLeft = gameTime;

             container.innerHTML = `<div class="speed-game-hud"><div class="speed-game-timer">${timeLeft}</div><div class="lives-container">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div></div><div class="speed-game-area"></div>`;
             
             const gameArea = container.querySelector('.speed-game-area');
             const timerDisplay = container.querySelector('.speed-game-timer');
             const livesDisplay = container.querySelector('.lives-container');

             const gameLoop = setInterval(() => {
                const healthy = Math.random() > 0.5;
                const icon = document.createElement('div');
                icon.className = 'game-icon';
                icon.textContent = healthy ? 'üçé' : 'üç©';
                icon.style.left = `${Math.random() * 90}%`;
                icon.style.top = `-10%`;
                
                icon.addEventListener('click', () => {
                    if (healthy) {
                        score++;
                    } else {
                        lives--;
                        livesDisplay.textContent = '‚ù§Ô∏è'.repeat(lives) + 'üñ§'.repeat(3 - lives);
                        document.getElementById('minigame-screen').classList.add('shake');
                        setTimeout(() => document.getElementById('minigame-screen').classList.remove('shake'), 300);
                        if (lives <= 0) {
                           endMinigame(false);
                        }
                    }
                    icon.remove();
                });
                gameArea.appendChild(icon);

                let top = -10;
                const fallInterval = setInterval(() => {
                    top += 1.5;
                    icon.style.top = `${top}%`;
                    if (top > 110) {
                        clearInterval(fallInterval);
                        icon.remove();
                    }
                }, 50);
                activeGameIntervals.push(fallInterval);

             }, 700);
             activeGameIntervals.push(gameLoop);

             const countdownInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 0) {
                    endMinigame(score >= 5);
                }
             }, 1000);
             activeGameIntervals.push(countdownInterval);
        }

        function setupInteligenciaGame(container, stationId) {
            const questions = {
                mental: { q: "Mito ou Verdade: Falar sobre sentimentos √© sinal de fraqueza.", a: false },
                adolescencia: { q: "Mito ou Verdade: √â normal se sentir confuso sobre o futuro na adolesc√™ncia.", a: true }
            };
            const currentQuestion = questions[stationId];
            const hint = gameState.player.attributes.inteligencia > 3 ? "(Dica: Confiar nos outros √© uma for√ßa!)" : "";
            
            document.querySelector('#minigame-screen .minigame-instructions').textContent = `Responda corretamente. ${hint}`;
            container.innerHTML = `<div class="quiz-question">${currentQuestion.q}</div><div class="quiz-options"><button data-answer="false">Mito</button><button data-answer="true">Verdade</button></div>`;
            
            container.querySelectorAll('button').forEach(btn => {
                btn.onclick = () => endMinigame(btn.dataset.answer === 'true' === currentQuestion.a);
            });
        }

        function setupCarismaGame(container) {
            const baseOptions = [
                { text: "Ignorar. N√£o √© problema seu.", correct: false },
                { text: "Ouvir com aten√ß√£o e oferecer ajuda.", correct: true },
                { text: "Contar para todo mundo para ver se algu√©m ajuda.", correct: false }
            ];
            
            if (gameState.player.attributes.carisma > 3) {
                baseOptions[0].text = "(Ignorar pode piorar as coisas)";
            }

            document.querySelector('#minigame-screen .minigame-instructions').textContent = "Um amigo parece triste e te procura para conversar. O que voc√™ faz?";
            container.innerHTML = `<div class="dialogue-scenario">Escolha a melhor abordagem:</div><div class="dialogue-options">${baseOptions.map(opt => `<button data-correct="${opt.correct}">${opt.text}</button>`).join('')}</div>`;

            container.querySelectorAll('button').forEach(btn => {
                btn.onclick = () => endMinigame(btn.dataset.correct === 'true');
            });
        }

        function startQrScanner() {
            const qrReaderElement = document.getElementById('qr-reader');
            const scannerMessage = document.getElementById('scanner-message');
            const stationToUnlock = gameState.stationToUnlock;
            const expectedQrValue = STATIONS[stationToUnlock].qrValue;
            
            qrReaderElement.classList.remove('success', 'error');
            scannerMessage.textContent = "Aponte a c√¢mera para o QR Code da esta√ß√£o.";
            scannerMessage.style.color = 'var(--color-light)';

            if (window.html5QrCode && window.html5QrCode.isScanning) return;
            window.html5QrCode = new Html5Qrcode("qr-reader");

            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                if (decodedText === expectedQrValue) {
                    scannerMessage.textContent = "C√≥digo correto! Desbloqueando...";
                    qrReaderElement.classList.add('success');
                    window.html5QrCode.stop().then(() => handleScan(true)).catch(err => console.error(err));
                } else {
                    scannerMessage.textContent = "QR Code errado. Tente o c√≥digo da esta√ß√£o correta.";
                    qrReaderElement.classList.add('error');
                    setTimeout(() => qrReaderElement.classList.remove('error'), 1000);
                }
            };
            const config = { fps: 10, qrbox: { width: 200, height: 200 } };
            window.html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                .catch(err => scannerMessage.textContent = "N√£o foi poss√≠vel acessar a c√¢mera.");
        }

        function createStars() {
            const container = document.getElementById('stars-bg');
            if (container.children.length > 0) return;
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 2 + 1;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.animationDuration = `${Math.random() * 8 + 4}s`;
                star.style.animationDelay = `${Math.random() * 4}s`;
                container.appendChild(star);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            createStars();
            setupOnboarding();

            document.getElementById('start-mission-btn').addEventListener('click', () => {
                if (!gameState.player) {
                    const startBtn = document.getElementById('start-mission-btn');
                    startBtn.style.borderColor = "var(--color-accent2-glow)";
                    startBtn.style.boxShadow = "0 0 10px var(--color-accent2-glow)";
                    startBtn.textContent = "Escolha um Agente!";
                    setTimeout(() => {
                        startBtn.style.borderColor = "var(--color-primary-glow)";
                        startBtn.style.boxShadow = "0 0 5px var(--color-primary-glow), inset 0 0 5px var(--color-primary-glow)";
                        startBtn.textContent = "Iniciar Miss√£o";
                    }, 1500);
                    return;
                }
                setupHub();
                navigateTo('hub-screen');
            });
            
            document.getElementById('scanner-back-btn').addEventListener('click', () => {
                if (window.html5QrCode && window.html5QrCode.isScanning) {
                    window.html5QrCode.stop().catch(err => {});
                }
                navigateTo('hub-screen');
            });
            
            document.getElementById('retry-btn').addEventListener('click', () => {
                document.getElementById('failure-modal').classList.remove('visible');
                startMinigame(gameState.stationToUnlock);
            });
            document.getElementById('fail-back-to-hub-btn').addEventListener('click', () => {
                document.getElementById('failure-modal').classList.remove('visible');
                navigateTo('hub-screen');
            });

            document.getElementById('modal-close-btn').addEventListener('click', () => {
                document.getElementById('discovery-modal').classList.remove('visible');
                setupHub();
                const allUnlocked = Object.values(gameState.stations).every(s => s.unlocked);
                if (allUnlocked) {
                    unlockAchievement('game_complete');
                    createPixelAvatar(gameState.player, document.getElementById('completion-avatar'));
                    navigateTo('completion-screen');
                } else {
                    navigateTo('hub-screen');
                }
            });

            document.getElementById('hub-overlay').addEventListener('click', () => {
                setupAgentPass();
                navigateTo('pass-screen');
            });
            
            document.getElementById('pass-back-btn').addEventListener('click', () => {
                navigateTo('hub-screen');
            });
        });
    </script>
</body>
</html>
